<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Firebase Realtime</title>
    <!-- Estilos CSS (Igual que antes) -->
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #e5ddd5; margin: 0; display: flex; justify-content: center; height: 100vh; }
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10; }
        .login-box { background: white; padding: 30px; border-radius: 10px; text-align: center; }
        .login-box input { padding: 10px; margin-bottom: 10px; width: 200px; border: 1px solid #ccc; border-radius: 5px; }
        .login-box button { padding: 10px 20px; background: #075e54; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .chat-container { width: 100%; max-width: 600px; background: #fff; display: flex; flex-direction: column; height: 100%; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        header { background-color: #075e54; color: white; padding: 15px; text-align: center; font-weight: bold; }
        #messages-list { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background-color: #e5ddd5; }
        .msg { max-width: 70%; padding: 8px 15px; border-radius: 10px; font-size: 14px; position: relative; word-wrap: break-word; }
        .sent { background-color: #dcf8c6; align-self: flex-end; border-top-right-radius: 0; }
        .received { background-color: white; align-self: flex-start; border-top-left-radius: 0; }
        form { display: flex; padding: 10px; background: #f0f0f0; }
        form input { flex: 1; padding: 10px; border-radius: 20px; border: none; outline: none; margin-right: 10px; }
        form button { background: #075e54; color: white; border: none; padding: 10px 20px; border-radius: 50%; cursor: pointer; }
        .hidden { display: none !important; }
        .msg strong { display: block; font-size: 11px; color: #d32f2f; margin-bottom: 3px;}
    </style>

    <!-- 1. IMPORTAR FIREBASE (Versión Compat - Más estable para ejecutar localmente) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>

    <!-- Login -->
    <div id="login-screen">
        <div class="login-box">
            <h2>Chat en Vivo</h2>
            <input type="text" id="usernameInput" placeholder="Tu nombre..." autocomplete="off">
            <button id="btnLogin">Entrar al Chat</button>
        </div>
    </div>

    <!-- Chat -->
    <div class="chat-container hidden" id="chat-screen">
        <header>Sala de Chat</header>
        <div id="messages-list"></div>
        <form id="message-form">
            <input type="text" id="messageInput" placeholder="Escribe aquí..." autocomplete="off">
            <button type="submit">➤</button>
        </form>
    </div>

    <script>
        // ------------------------------------------------------------------
        // 2. PEGA TU CONFIGURACIÓN AQUÍ (Bórralo y pon lo que copiaste de Firebase)
        // ------------------------------------------------------------------
        const firebaseConfig = {
             apiKey: "AIzaSyDD4ZgShyZGEnTYbGwNprjHwLxSVOnHBGI",
             authDomain: "ja-chat-59c9e.firebaseapp.com",
             projectId: "ja-chat-59c9e",
             storageBucket: "ja-chat-59c9e.firebasestorage.app",
             messagingSenderId: "967850675224",
             appId: "1:967850675224:web:809c09d0a3aa117696076d"
        };

        // 3. INICIALIZAR (Sintaxis simplificada)
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ELEMENTOS DOM
        let currentUser = "";
        const loginScreen = document.getElementById('login-screen');
        const chatScreen = document.getElementById('chat-screen');
        const usernameInput = document.getElementById('usernameInput');
        const btnLogin = document.getElementById('btnLogin');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('messageInput');
        const messagesList = document.getElementById('messages-list');

        // Entrar
        btnLogin.addEventListener('click', () => {
            if(usernameInput.value.trim()) {
                currentUser = usernameInput.value.trim();
                loginScreen.classList.add('hidden');
                chatScreen.classList.remove('hidden');
                setupRealtimeListener();
            } else { alert("Pon un nombre"); }
        });

        // Enviar Mensaje
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if(text) {
                // Escribir en la base de datos
                db.collection("messages").add({
                    user: currentUser,
                    text: text,
                    // Usamos Date.now() para ordenar fácilmente
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).catch((error) => {
                    console.error("Error enviando:", error);
                });
                messageInput.value = "";
            }
        });

        // 4. ESCUCHAR EN TIEMPO REAL (Esta es la parte mágica)
        function setupRealtimeListener() {
            // .onSnapshot() se activa AUTOMÁTICAMENTE cuando alguien escribe
            db.collection("messages")
              .orderBy("timestamp", "asc")
              .onSnapshot((snapshot) => {
                  
                  // Limpiamos el chat para redibujarlo (simple pero efectivo)
                  messagesList.innerHTML = "";

                  snapshot.forEach((doc) => {
                      const data = doc.data();
                      const div = document.createElement('div');
                      
                      const type = data.user === currentUser ? 'sent' : 'received';
                      div.classList.add('msg', type);
                      
                      div.innerHTML = `<strong>${data.user}</strong> ${data.text}`;
                      messagesList.appendChild(div);
                  });

                  // Scroll abajo
                  messagesList.scrollTop = messagesList.scrollHeight;
              }, (error) => {
                  console.error("Error recibiendo mensajes:", error);
                  alert("Error: Revisa la consola (F12) o las Reglas de Firebase");
              });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- Meta viewport mejorado para evitar zoom y manejar el teclado -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>Red Mesh Chat - Secure</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* --- 1. ESTRUCTURA ANTI-MOVIMIENTO --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            /* Evita que el cuerpo se mueva o haga scroll */
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            background-color: #050505;
        }

        body {
            background-image: 
                radial-gradient(at 0% 0%, hsla(350,90%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(0,0%,15%,1) 0, transparent 50%), 
                radial-gradient(at 100% 100%, hsla(350,90%,20%,1) 0, transparent 50%), 
                radial-gradient(at 0% 100%, hsla(0,0%,10%,1) 0, transparent 50%);
            display: flex; 
            justify-content: center; 
            align-items: center;
        }

        /* Contenedor Principal Ajustable */
        .app-container {
            width: 100%; 
            max-width: 450px; 
            height: 100%; /* Se ajustarÃ¡ por JS en mÃ³viles */
            background: rgba(20, 20, 25, 0.95); 
            display: flex; 
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        @media (min-width: 451px) {
            .app-container {
                height: 90vh; 
                border-radius: 30px;
                border: 1px solid rgba(255,255,255,0.1);
                box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            }
        }

        /* --- 2. PANTALLAS --- */
        .screen {
            position: absolute; width: 100%; height: 100%;
            background: #121212; z-index: 50; padding: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .input-dark {
            width: 100%; padding: 14px; border-radius: 12px;
            border: 1px solid #333; background: #1e1e1e;
            color: white; outline: none; 
            font-size: 16px; /* MÃ­nimo 16px para evitar zoom en iOS */
        }

        /* --- 3. CHAT UI --- */
        .chat-header {
            flex-shrink: 0;
            height: 60px; padding: 0 15px;
            background: #19191e;
            border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between;
            z-index: 10;
        }

        #messages-list {
            flex: 1; /* Ocupa el espacio restante */
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: transparent;
            -webkit-overflow-scrolling: touch;
        }

        .chat-input-area {
            flex-shrink: 0;
            padding: 10px;
            background: #19191e;
            border-top: 1px solid #333;
            display: flex;
            gap: 8px;
            align-items: center;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }

        /* --- ESTILOS DE BURBUJAS --- */
        .msg-row { display: flex; gap: 8px; align-items: flex-end; max-width: 85%; margin-bottom: 4px; }
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .sent { flex-direction: row-reverse; align-self: flex-end; }
        .sent .bubble { background: linear-gradient(135deg, #ff4b5c, #d63031); color: white; border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; }
        .received .bubble { background: #2d3436; color: #eee; border-bottom-left-radius: 2px; }
        .msg-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        
        /* Botones e Inputs del Chat */
        .chat-input-area input {
            flex: 1; padding: 12px 15px; border-radius: 25px; border: none;
            background: #333; color: white; outline: none; font-size: 16px;
        }
        .icon-btn { font-size: 20px; background: none; border: none; color: #aaa; cursor: pointer; }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; background: #ff4b5c; color: white; border: none; display:flex; align-items:center; justify-content:center; }

        .hidden { display: none !important; }

        /* Canvas Modal */
        .drawing-modal { position: absolute; top:0; left:0; width:100%; height:100%; background:#121212; z-index:100; display:flex; flex-direction:column; padding:10px; }
        .canvas-box { flex:1; background:white; border-radius:15px; touch-action:none; }
    </style>
</head>
<body>

    <div class="app-container" id="main-app">
        
        <!-- PANTALLA AUTH -->
        <div id="auth-screen" class="screen">
            <h2 style="color:#ff4b5c; margin-bottom: 20px;">RED CHAT ID</h2>
            <div id="register-view" style="width: 100%; text-align: center;">
                <input type="text" id="reg-user" class="input-dark" placeholder="Usuario" style="margin-bottom:10px;">
                <input type="password" id="reg-pass" class="input-dark" placeholder="ContraseÃ±a">
                <button id="btn-do-register" class="send-btn" style="width:100%; border-radius:12px; margin-top:15px; height:50px;">CREAR CUENTA</button>
                <button class="icon-btn" style="font-size:13px; margin-top:10px;" onclick="toggleAuth('login')">Â¿Ya tienes cuenta? Login</button>
            </div>

            <div id="login-view" class="hidden" style="width: 100%; text-align: center;">
                <input type="text" id="login-user" class="input-dark" placeholder="Usuario" style="margin-bottom:10px;">
                <input type="password" id="login-pass" class="input-dark" placeholder="ContraseÃ±a">
                <button id="btn-do-login" class="send-btn" style="width:100%; border-radius:12px; margin-top:15px; height:50px;">ENTRAR</button>
                <button class="icon-btn" style="font-size:13px; margin-top:10px;" onclick="toggleAuth('register')">Â¿Eres nuevo? Registro</button>
            </div>
        </div>

        <!-- CHAT -->
        <div id="chat-screen" class="hidden" style="flex:1; display: flex; flex-direction: column;">
            <header class="chat-header">
                <span style="font-weight:600; color:white;">Mesh Chat</span>
                <button onclick="logout()" class="icon-btn">ðŸšª</button>
            </header>

            <div id="messages-list"></div>

            <div class="chat-input-area">
                <button onclick="document.getElementById('img-input').click()" class="icon-btn">ðŸ“·</button>
                <input type="file" id="img-input" style="display:none" accept="image/*">
                <input type="text" id="msg-input" placeholder="Escribe algo..." autocomplete="off">
                <button onclick="sendMsg()" class="send-btn">âž¤</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÃ“N FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDD4ZgShyZGEnTYbGwNprjHwLxSVOnHBGI",
            authDomain: "ja-chat-59c9e.firebaseapp.com",
            projectId: "ja-chat-59c9e",
            storageBucket: "ja-chat-59c9e.firebasestorage.app",
            messagingSenderId: "967850675224",
            appId: "1:967850675224:web:809c09d0a3aa117696076d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- SOLUCIÃ“N TECLADO MÃ“VIL (Visual Viewport) ---
        // Esto detecta exactamente cuÃ¡nto mide la pantalla libre de teclado
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                const viewHeight = window.visualViewport.height;
                document.getElementById('main-app').style.height = viewHeight + 'px';
                // Hacer scroll al final cuando se abre el teclado
                setTimeout(() => {
                    const list = document.getElementById('messages-list');
                    list.scrollTop = list.scrollHeight;
                }, 100);
            });
        }

        // --- LÃ“GICA DE USUARIOS ---
        let currentUser = null;

        function toggleAuth(view) {
            document.getElementById('register-view').classList.toggle('hidden', view === 'login');
            document.getElementById('login-view').classList.toggle('hidden', view === 'register');
        }

        async function register() {
            const u = document.getElementById('reg-user').value.trim();
            const p = document.getElementById('reg-pass').value.trim();
            if(!u || !p) return alert("Llena los datos");
            await db.collection("users").doc(u.toLowerCase()).set({ name: u, pass: p });
            login(u, p);
        }

        async function login(user, pass) {
            const u = user || document.getElementById('login-user').value.trim();
            const p = pass || document.getElementById('login-pass').value.trim();
            const doc = await db.collection("users").doc(u.toLowerCase()).get();
            if(doc.exists && doc.data().pass === p) {
                currentUser = u;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('chat-screen').classList.remove('hidden');
                loadMessages();
            } else { alert("Error de acceso"); }
        }

        function logout() { location.reload(); }

        document.getElementById('btn-do-register').onclick = () => register();
        document.getElementById('btn-do-login').onclick = () => login();

        // --- LÃ“GICA CHAT ---
        function sendMsg() {
            const input = document.getElementById('msg-input');
            const txt = input.value.trim();
            if(!txt) return;
            db.collection("messages").add({
                user: currentUser,
                text: txt,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            input.value = "";
        }

        function loadMessages() {
            db.collection("messages").orderBy("timestamp", "asc").onSnapshot(snap => {
                const list = document.getElementById('messages-list');
                list.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const isMe = d.user === currentUser;
                    const div = document.createElement('div');
                    div.className = `msg-row ${isMe ? 'sent' : 'received'}`;
                    div.innerHTML = `
                        <div class="bubble">
                            <small style="display:block; font-size:9px; opacity:0.7">${d.user}</small>
                            ${d.text}
                        </div>
                    `;
                    list.appendChild(div);
                });
                list.scrollTop = list.scrollHeight;
            });
        }

        document.getElementById('msg-input').onkeypress = (e) => { if(e.key==='Enter') sendMsg(); };
    </script>
</body>
</html>

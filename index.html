<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Red Dark Chat - Artist</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* --- ESTILOS GENERALES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
        
        body {
            height: 100vh;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
            background-color: #050505;
            background-image: 
                radial-gradient(at 0% 0%, hsla(350,90%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(0,0%,15%,1) 0, transparent 50%), 
                radial-gradient(at 100% 100%, hsla(350,90%,20%,1) 0, transparent 50%), 
                radial-gradient(at 0% 100%, hsla(0,0%,10%,1) 0, transparent 50%);
            color: white;
            /* Prevenir scroll rebote en m√≥viles */
            overscroll-behavior: none;
        }

        .app-container {
            width: 100%; max-width: 420px; height: 95vh;
            background: rgba(30, 30, 35, 0.85); backdrop-filter: blur(15px);
            border-radius: 35px; border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }

        /* --- PANTALLAS (LOGIN / WELCOME) --- */
        .screen {
            position: absolute; width: 100%; height: 100%;
            background: #121212; z-index: 20; padding: 30px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; transition: opacity 0.5s ease;
        }
        
        .avatar-preview {
            width: 100px; height: 100px; border-radius: 50%;
            background: #252525; border: 2px dashed #ff4b5c;
            margin-bottom: 20px; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            position: relative; cursor: pointer;
        }
        .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
        
        .input-dark {
            width: 100%; padding: 15px; border-radius: 12px;
            border: 1px solid #333; background: #1e1e1e;
            color: white; margin-bottom: 15px; outline: none;
        }
        .btn-main {
            width: 100%; padding: 15px; border-radius: 12px; border: none;
            background: linear-gradient(135deg, #ff4b5c, #d63031);
            color: white; font-weight: 600; cursor: pointer; margin-bottom: 10px;
        }
        .btn-sec { background: transparent; border: 1px solid #444; color: #aaa; }

        /* --- CHAT HEADER --- */
        .chat-header {
            padding: 15px 20px; background: rgba(20, 20, 20, 0.9);
            border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between;
        }
        .header-controls { display: flex; gap: 15px; align-items: center; }
        .icon-btn { background: none; border: none; font-size: 18px; cursor: pointer; transition: transform 0.2s; }
        .icon-btn:hover { transform: scale(1.2); }
        .my-mini-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid #ff4b5c; }

        /* --- CHAT LIST --- */
        #messages-list {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 12px;
        }
        #messages-list::-webkit-scrollbar { width: 4px; }
        #messages-list::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

        .msg-row { display: flex; gap: 10px; align-items: flex-end; max-width: 85%; }
        .msg-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; background: #333; flex-shrink: 0; }
        
        .bubble {
            padding: 10px 14px; border-radius: 18px; font-size: 13px;
            line-height: 1.4; position: relative; word-wrap: break-word;
        }
        .chat-image-content {
            max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; background: white;
        }

        .sent { flex-direction: row-reverse; align-self: flex-end; }
        .sent .bubble { background: linear-gradient(135deg, #ff4b5c, #e84118); color: white; border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; }
        .received .bubble { background: #2d3436; color: #dfe6e9; border-bottom-left-radius: 2px; }
        
        .delete-btn {
            position: absolute; top: -8px; left: -8px; width: 20px; height: 20px;
            background: #fff; color: #d63031; border-radius: 50%;
            display: none; justify-content: center; align-items: center; cursor: pointer; font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 5;
        }
        .sent:hover .delete-btn { display: flex; }

        /* --- INPUT AREA --- */
        .chat-input-area {
            padding: 10px 15px; background: rgba(20, 20, 20, 0.9);
            display: flex; gap: 8px; align-items: center; position: relative;
        }
        .chat-input-area input[type="text"] {
            flex: 1; padding: 12px; border-radius: 25px; border: none;
            background: #2d3436; color: white; outline: none;
        }
        .tool-btn { font-size: 20px; background: none; border: none; cursor: pointer; color: #aaa; padding: 5px; }
        .tool-btn:hover { color: #fff; transform: scale(1.1); }
        .send-btn {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: #ff4b5c; color: white; cursor: pointer;
        }

        /* EMOJI PICKER */
        .emoji-picker {
            position: absolute; bottom: 70px; left: 10px;
            background: #2d3436; padding: 10px; border-radius: 15px;
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 10;
        }
        .emoji-btn { font-size: 20px; cursor: pointer; padding: 5px; border-radius: 5px; }
        .emoji-btn:hover { background: rgba(255,255,255,0.1); }

        /* --- NUEVO: MODAL DE DIBUJO --- */
        .drawing-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 50; display: flex; flex-direction: column;
            padding: 10px;
        }
        
        .canvas-container {
            flex: 1; background: white; /* HOJA BLANCA */
            border-radius: 15px; margin: 10px 0;
            overflow: hidden; position: relative;
            touch-action: none; /* Importante para dibujar en m√≥vil */
            cursor: crosshair;
        }
        
        canvas { display: block; width: 100%; height: 100%; }

        .draw-controls {
            display: flex; justify-content: space-between; gap: 10px; padding-bottom: 10px;
        }
        .btn-draw-action {
            flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer;
        }
        .btn-cancel { background: #333; color: white; }
        .btn-clear { background: #ff9f43; color: white; }
        .btn-send-draw { background: #ff4b5c; color: white; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- LOGIN SCREEN -->
        <div id="login-screen" class="screen">
            <h2 style="color:#ff4b5c; margin-bottom:5px;">RED CHAT</h2>
            <p style="font-size:12px; color:#aaa; margin-bottom:20px;">Crea tu perfil</p>

            <label for="fileInputAvatar" class="avatar-preview">
                <img id="avatarPreviewImg" src="" style="display:none">
                <span id="avatarIcon" style="font-size:30px; opacity:0.5;">üì∑</span>
            </label>
            <input type="file" id="fileInputAvatar" accept="image/*" style="display:none">

            <input type="text" id="usernameInput" class="input-dark" placeholder="Tu Apodo" autocomplete="off">
            <button id="btnLogin" class="btn-main">ENTRAR</button>
        </div>

        <!-- WELCOME SCREEN -->
        <div id="welcome-screen" class="screen hidden">
            <div style="width:80px; height:80px; border-radius:50%; overflow:hidden; border:2px solid #ff4b5c; margin-bottom:15px;">
                <img id="welcomeAvatar" src="" style="width:100%; height:100%; object-fit:cover;">
            </div>
            <h3 style="margin-bottom:5px;">Hola, <span id="welcomeName" style="color:#ff4b5c">User</span></h3>
            <p style="font-size:12px; color:#aaa; margin-bottom:30px;">¬øQuieres continuar?</p>
            <button id="btnContinue" class="btn-main">CONTINUAR</button>
            <button id="btnSwitch" class="btn-main btn-sec">USAR OTRA CUENTA</button>
        </div>

        <!-- CHAT SCREEN -->
        <div id="chat-screen" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
            <header class="chat-header">
                <span style="font-weight:600; font-size:14px;">Sala Principal</span>
                <div class="header-controls">
                    <button id="btnClearAll" class="icon-btn" title="Borrar Chat">üóëÔ∏è</button>
                    <button id="btnLogout" class="icon-btn" title="Salir">üö™</button>
                    <img id="headerAvatar" class="my-mini-avatar" src="">
                </div>
            </header>

            <div id="messages-list"></div>
            
            <div id="emojiPicker" class="emoji-picker hidden"></div>

            <div class="chat-input-area">
                <button id="btnEmojiToggle" class="tool-btn">üòÄ</button>
                <button id="btnImgUpload" class="tool-btn">üì∑</button>
                <button id="btnOpenDraw" class="tool-btn">üñåÔ∏è</button> <!-- NUEVO BOTON PINCEL -->
                
                <input type="file" id="chatFileInput" accept="image/*" style="display:none">
                <input type="text" id="messageInput" placeholder="Mensaje..." autocomplete="off">
                <button id="btnSend" class="send-btn">‚û§</button>
            </div>
        </div>

        <!-- NUEVO: PANTALLA DE DIBUJO (MODAL) -->
        <div id="drawing-modal" class="drawing-modal hidden">
            <h3 style="color:white; text-align:center; font-size:14px; margin-top:10px;">Dibuja algo</h3>
            
            <div class="canvas-container" id="canvasContainer">
                <canvas id="drawCanvas"></canvas>
            </div>
            
            <div class="draw-controls">
                <button id="btnCancelDraw" class="btn-draw-action btn-cancel">Cancelar</button>
                <button id="btnClearDraw" class="btn-draw-action btn-clear">Limpiar</button>
                <button id="btnSendDraw" class="btn-draw-action btn-send-draw">Enviar</button>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // 1. FIREBASE CONFIG (¬°PONER TUS DATOS!)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDD4ZgShyZGEnTYbGwNprjHwLxSVOnHBGI",
            authDomain: "ja-chat-59c9e.firebaseapp.com",
            projectId: "ja-chat-59c9e",
            storageBucket: "ja-chat-59c9e.firebasestorage.app",
            messagingSenderId: "967850675224",
            appId: "1:967850675224:web:809c09d0a3aa117696076d"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ==========================================
        // 2. L√ìGICA PRINCIPAL
        // ==========================================
        let currentUser = "";
        let currentAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png"; 

        const screens = {
            login: document.getElementById('login-screen'),
            welcome: document.getElementById('welcome-screen'),
            chat: document.getElementById('chat-screen'),
            draw: document.getElementById('drawing-modal') // Nuevo Modal
        };
        const inputs = {
            user: document.getElementById('usernameInput'),
            msg: document.getElementById('messageInput'),
            fileAvatar: document.getElementById('fileInputAvatar'),
            fileChat: document.getElementById('chatFileInput')
        };
        const emojiPicker = document.getElementById('emojiPicker');

        // --- GESTI√ìN DE SESI√ìN ---
        window.onload = () => {
            const savedUser = localStorage.getItem('chat_user');
            const savedAvatar = localStorage.getItem('chat_avatar');
            if (savedUser) {
                currentUser = savedUser;
                currentAvatar = savedAvatar || currentAvatar;
                document.getElementById('welcomeName').textContent = currentUser;
                document.getElementById('welcomeAvatar').src = currentAvatar;
                screens.login.classList.add('hidden');
                screens.welcome.classList.remove('hidden');
            }
        };

        document.getElementById('btnContinue').addEventListener('click', enterChat);
        document.getElementById('btnSwitch').addEventListener('click', () => {
            localStorage.clear(); screens.welcome.classList.add('hidden'); screens.login.classList.remove('hidden');
        });
        document.getElementById('btnLogout').addEventListener('click', () => {
            if(confirm("¬øSalir?")) location.reload();
        });

        // --- LOGIN ---
        document.getElementById('btnLogin').addEventListener('click', () => {
            const name = inputs.user.value.trim();
            if(!name) return alert("Falta nombre");
            currentUser = name;
            localStorage.setItem('chat_user', currentUser);
            localStorage.setItem('chat_avatar', currentAvatar);
            screens.login.classList.add('hidden');
            enterChat();
        });

        function enterChat() {
            document.getElementById('headerAvatar').src = currentAvatar;
            screens.welcome.classList.add('hidden');
            screens.chat.classList.remove('hidden');
            loadMessages();
        }

        // --- IM√ÅGENES ---
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX = 400; 
                    let w = img.width, h = img.height;
                    if(w > h) { if(w > MAX) { h *= MAX/w; w = MAX; } }
                    else { if(h > MAX) { w *= MAX/h; h = MAX; } }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    callback(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        inputs.fileAvatar.addEventListener('change', (e) => {
            if(e.target.files[0]) compressImage(e.target.files[0], (b64) => {
                currentAvatar = b64;
                document.getElementById('avatarPreviewImg').src = b64;
                document.getElementById('avatarPreviewImg').style.display = 'block';
                document.getElementById('avatarIcon').style.display = 'none';
            });
        });

        document.getElementById('btnImgUpload').addEventListener('click', () => inputs.fileChat.click());
        inputs.fileChat.addEventListener('change', (e) => {
            if(e.target.files[0]) compressImage(e.target.files[0], (b64) => sendMessage(null, b64));
        });

        // --- EMOJIS ---
        ["üòÄ","üòÇ","üòç","üòé","üò≠","üò°","üëç","üëé","üéâ","‚ù§Ô∏è","üî•","üëª"].forEach(emo => {
            const s = document.createElement('span'); s.textContent = emo; s.className = "emoji-btn";
            s.onclick = () => { inputs.msg.value += emo; emojiPicker.classList.add('hidden'); };
            emojiPicker.appendChild(s);
        });
        document.getElementById('btnEmojiToggle').addEventListener('click', () => emojiPicker.classList.toggle('hidden'));

        // ==========================================
        // 3. L√ìGICA DE DIBUJO (CANVAS) - NUEVO
        // ==========================================
        const canvas = document.getElementById('drawCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0, lastY = 0;

        // Abrir Modal
        document.getElementById('btnOpenDraw').addEventListener('click', () => {
            screens.draw.classList.remove('hidden');
            // Ajustar tama√±o del canvas al contenedor visible
            const container = document.getElementById('canvasContainer');
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            
            // Configurar Pincel
            ctx.fillStyle = "white";
            ctx.fillRect(0,0, canvas.width, canvas.height); // Fondo blanco
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = 4;
            ctx.strokeStyle = '#000000'; // Color l√°piz
        });

        // Cerrar Modal
        document.getElementById('btnCancelDraw').addEventListener('click', () => screens.draw.classList.add('hidden'));
        
        // Limpiar
        document.getElementById('btnClearDraw').addEventListener('click', () => {
            ctx.fillStyle = "white";
            ctx.fillRect(0,0, canvas.width, canvas.height);
        });

        // Enviar Dibujo
        document.getElementById('btnSendDraw').addEventListener('click', () => {
            const drawingUrl = canvas.toDataURL('image/png');
            sendMessage(null, drawingUrl);
            screens.draw.classList.add('hidden');
        });

        // Eventos Mouse
        function draw(e) {
            if (!isDrawing) return;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }
        canvas.addEventListener('mousedown', (e) => { isDrawing = true; [lastX, lastY] = [e.offsetX, e.offsetY]; });
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', () => isDrawing = false);
        canvas.addEventListener('mouseout', () => isDrawing = false);

        // Eventos Touch (M√≥vil)
        function getTouchPos(canvasDom, touchEvent) {
            var rect = canvasDom.getBoundingClientRect();
            return {
                x: touchEvent.touches[0].clientX - rect.left,
                y: touchEvent.touches[0].clientY - rect.top
            };
        }
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); isDrawing = true;
            const pos = getTouchPos(canvas, e);
            [lastX, lastY] = [pos.x, pos.y];
        }, {passive: false});
        
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault(); if(!isDrawing) return;
            const pos = getTouchPos(canvas, e);
            ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(pos.x, pos.y); ctx.stroke();
            [lastX, lastY] = [pos.x, pos.y];
        }, {passive: false});
        
        canvas.addEventListener('touchend', () => isDrawing = false);

        // ==========================================
        // 4. CHAT CORE
        // ==========================================
        document.getElementById('btnSend').addEventListener('click', () => {
            const txt = inputs.msg.value.trim();
            if(txt) sendMessage(txt, null);
        });

        function sendMessage(text, imgBase64) {
            db.collection("messages").add({
                user: currentUser, avatar: currentAvatar,
                text: text || "", image: imgBase64 || null,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            inputs.msg.value = ""; emojiPicker.classList.add('hidden');
        }

        function loadMessages() {
            db.collection("messages").orderBy("timestamp", "asc").onSnapshot(snap => {
                const list = document.getElementById('messages-list');
                list.innerHTML = "";
                snap.forEach(doc => {
                    const data = doc.data();
                    const isMe = data.user === currentUser;
                    const row = document.createElement('div');
                    row.className = `msg-row ${isMe ? 'sent' : 'received'}`;
                    
                    let content = "";
                    if(data.image) content += `<img src="${data.image}" class="chat-image-content">`;
                    if(data.text) content += `<div style="margin-top:4px">${data.text}</div>`;

                    row.innerHTML = `
                        ${!isMe ? `<img src="${data.avatar}" class="msg-avatar">` : ''}
                        <div class="bubble">
                            ${isMe ? `<div class="delete-btn" onclick="deleteMsg('${doc.id}')">‚úï</div>` : ''}
                            ${!isMe ? `<small style="opacity:0.6; font-size:10px; display:block">${data.user}</small>` : ''}
                            ${content}
                        </div>
                        ${isMe ? `<img src="${data.avatar}" class="msg-avatar">` : ''}
                    `;
                    list.appendChild(row);
                });
                list.scrollTop = list.scrollHeight;
            });
        }

        window.deleteMsg = (id) => { if(confirm("¬øBorrar?")) db.collection("messages").doc(id).delete(); };
        document.getElementById('btnClearAll').addEventListener('click', async () => {
            if(confirm("‚ö† ¬øBorrar TODO el chat para TODOS?")) {
                const snap = await db.collection("messages").get();
                snap.forEach(doc => doc.ref.delete());
            }
        });

    </script>
</body>
</html>

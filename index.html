<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Dark Chat - Pro</title>
    <!-- Fuente Google -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* --- 1. EST√âTICA Y FONDO DE CALIDAD --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
        
        body {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            /* Fondo Degradado de Calidad (Radial Mesh) */
            background-color: #050505;
            background-image: 
                radial-gradient(at 0% 0%, hsla(350,90%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(0,0%,15%,1) 0, transparent 50%), 
                radial-gradient(at 100% 100%, hsla(350,90%,20%,1) 0, transparent 50%), 
                radial-gradient(at 0% 100%, hsla(0,0%,10%,1) 0, transparent 50%);
            color: white;
        }

        /* Contenedor Principal */
        .app-container {
            width: 100%;
            max-width: 420px;
            height: 95vh;
            background: rgba(30, 30, 35, 0.85);
            backdrop-filter: blur(15px);
            border-radius: 35px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- PANTALLA DE LOGIN --- */
        #login-screen {
            position: absolute; width: 100%; height: 100%;
            background: #121212;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; padding: 30px; text-align: center;
            transition: opacity 0.5s ease;
        }

        .avatar-preview {
            width: 100px; height: 100px;
            border-radius: 50%;
            background: #252525;
            border: 2px dashed #ff4b5c;
            margin-bottom: 20px;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            position: relative;
            cursor: pointer;
        }
        .avatar-preview img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .avatar-preview span { font-size: 30px; opacity: 0.5; }
        .avatar-preview:hover { background: #333; }

        input[type="file"] { display: none; }

        .input-dark {
            width: 100%; padding: 15px; border-radius: 12px;
            border: 1px solid #333; background: #1e1e1e;
            color: white; margin-bottom: 15px; outline: none;
            transition: 0.3s;
        }
        .input-dark:focus { border-color: #ff4b5c; box-shadow: 0 0 10px rgba(255, 75, 92, 0.2); }

        .btn-main {
            width: 100%; padding: 15px; border-radius: 12px; border: none;
            background: linear-gradient(135deg, #ff4b5c, #d63031);
            color: white; font-weight: 600; cursor: pointer;
            box-shadow: 0 4px 15px rgba(214, 48, 49, 0.4);
            transition: transform 0.2s;
        }
        .btn-main:active { transform: scale(0.97); }

        /* --- PANTALLA CHAT --- */
        .chat-header {
            padding: 15px 20px;
            background: rgba(20, 20, 20, 0.9);
            border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between;
        }

        .header-controls {
            display: flex; align-items: center; gap: 15px;
        }

        /* Bot√≥n de Borrar TODO (Header) */
        .btn-clear-all {
            background: transparent; border: none; font-size: 18px; cursor: pointer;
            color: #d63031; opacity: 0.7; transition: 0.3s;
        }
        .btn-clear-all:hover { opacity: 1; transform: scale(1.1); text-shadow: 0 0 8px red; }

        .my-mini-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid #ff4b5c; }

        #messages-list {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 12px;
        }
        #messages-list::-webkit-scrollbar { width: 4px; }
        #messages-list::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

        .msg-row { display: flex; gap: 10px; align-items: flex-end; max-width: 85%; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .msg-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; background: #333; flex-shrink: 0; }
        
        .bubble {
            padding: 10px 14px; border-radius: 18px;
            font-size: 13px; line-height: 1.4; position: relative;
            word-wrap: break-word;
        }

        .sent { flex-direction: row-reverse; align-self: flex-end; }
        .sent .bubble {
            background: linear-gradient(135deg, #ff4b5c, #e84118);
            color: white; border-bottom-right-radius: 2px;
        }
        
        .received { align-self: flex-start; }
        .received .bubble {
            background: #2d3436; color: #dfe6e9;
            border-bottom-left-radius: 2px;
        }
        .user-name { font-size: 10px; opacity: 0.6; margin-bottom: 2px; display: block; }

        /* Bot√≥n de Borrar Individual */
        .delete-btn {
            position: absolute; top: -8px; left: -8px;
            width: 20px; height: 20px; background: #fff;
            color: #d63031; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 12px; border: 1px solid #ddd;
            display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .sent:hover .delete-btn { display: flex; }

        .chat-input-area {
            padding: 15px; background: rgba(20, 20, 20, 0.9);
            display: flex; gap: 10px; align-items: center;
        }
        .chat-input-area input {
            flex: 1; padding: 12px; border-radius: 25px;
            border: none; background: #2d3436; color: white; outline: none;
        }
        .send-btn {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: #ff4b5c; color: white; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- LOGIN -->
        <div id="login-screen">
            <h2 style="color:#ff4b5c; margin-bottom:5px;">RED CHAT</h2>
            <p style="font-size:12px; color:#aaa; margin-bottom:20px;">Sube tu foto y √∫nete</p>

            <label for="fileInput" class="avatar-preview">
                <img id="avatarPreviewImg" src="" alt="">
                <span id="avatarIcon">üì∑</span>
            </label>
            <input type="file" id="fileInput" accept="image/*">

            <input type="text" id="usernameInput" class="input-dark" placeholder="Tu Apodo / Nickname" autocomplete="off">
            <button id="btnLogin" class="btn-main">ENTRAR</button>
        </div>

        <!-- CHAT -->
        <div id="chat-screen" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
            <header class="chat-header">
                <span style="font-weight:600; font-size:14px;">Sala Principal</span>
                
                <!-- Controles: Borrar todo y Avatar -->
                <div class="header-controls">
                    <!-- Bot√≥n NUEVO para vaciar el chat -->
                    <button id="btnClearAll" class="btn-clear-all" title="Vaciar chat para TODOS">üóëÔ∏è</button>
                    <img id="headerAvatar" class="my-mini-avatar" src="" alt="">
                </div>
            </header>

            <div id="messages-list"></div>

            <form id="message-form" class="chat-input-area">
                <input type="text" id="messageInput" placeholder="Escribe algo..." autocomplete="off">
                <button type="submit" class="send-btn">‚û§</button>
            </form>
        </div>

    </div>

    <script>
        // ==========================================
        // 1. CONFIGURACI√ìN FIREBASE (REEMPLAZAR AQUI)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDD4ZgShyZGEnTYbGwNprjHwLxSVOnHBGI",
            authDomain: "ja-chat-59c9e.firebaseapp.com",
            projectId: "ja-chat-59c9e",
            storageBucket: "ja-chat-59c9e.firebasestorage.app",
            messagingSenderId: "967850675224",
            appId: "1:967850675224:web:809c09d0a3aa117696076d"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // ==========================================
        // 2. L√ìGICA DE LA APP
        // ==========================================
        
        let currentUser = "";
        let currentAvatarBase64 = "https://cdn-icons-png.flaticon.com/512/847/847969.png"; 

        const loginScreen = document.getElementById('login-screen');
        const chatScreen = document.getElementById('chat-screen');
        const usernameInput = document.getElementById('usernameInput');
        const fileInput = document.getElementById('fileInput');
        const avatarPreviewImg = document.getElementById('avatarPreviewImg');
        const avatarIcon = document.getElementById('avatarIcon');
        const btnClearAll = document.getElementById('btnClearAll'); // Nuevo bot√≥n
        
        // --- PROCESAR IMAGEN ---
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(readerEvent) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_SIZE = 150;
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                        } else {
                            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        currentAvatarBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        avatarPreviewImg.src = currentAvatarBase64;
                        avatarPreviewImg.style.display = 'block';
                        avatarIcon.style.display = 'none';
                    }
                    img.src = readerEvent.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        // --- ENTRAR ---
        document.getElementById('btnLogin').addEventListener('click', () => {
            const name = usernameInput.value.trim();
            if(!name) return alert("Escribe un nombre");
            currentUser = name;
            document.getElementById('headerAvatar').src = currentAvatarBase64;
            loginScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            setupChat();
        });

        // --- ENVIAR ---
        document.getElementById('message-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const text = document.getElementById('messageInput').value.trim();
            if(text) {
                db.collection("messages").add({
                    user: currentUser,
                    avatar: currentAvatarBase64,
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('messageInput').value = "";
            }
        });

        // --- RENDERIZAR CHAT ---
        function setupChat() {
            db.collection("messages").orderBy("timestamp", "asc")
              .onSnapshot(snapshot => {
                  const list = document.getElementById('messages-list');
                  list.innerHTML = ""; 

                  snapshot.forEach(doc => {
                      const data = doc.data();
                      const id = doc.id; 
                      const isMe = data.user === currentUser;

                      const row = document.createElement('div');
                      row.className = `msg-row ${isMe ? 'sent' : 'received'}`;

                      row.innerHTML = `
                          ${!isMe ? `<img src="${data.avatar}" class="msg-avatar">` : ''}
                          <div class="bubble">
                              ${isMe ? `<div class="delete-btn" onclick="deleteMessage('${id}')">‚úï</div>` : ''}
                              ${!isMe ? `<span class="user-name">${data.user}</span>` : ''}
                              ${data.text}
                          </div>
                          ${isMe ? `<img src="${data.avatar}" class="msg-avatar">` : ''}
                      `;
                      list.appendChild(row);
                  });
                  list.scrollTop = list.scrollHeight;
              });
        }

        // --- BORRAR 1 MENSAJE (INDIVIDUAL) ---
        window.deleteMessage = function(docId) {
            if(confirm("¬øBorrar mensaje?")) {
                db.collection("messages").doc(docId).delete()
                    .catch(error => console.error("Error borrando:", error));
            }
        };

        // --- BORRAR TODO EL CHAT (GLOBAL) ---
        btnClearAll.addEventListener('click', async () => {
            const confirm1 = confirm("‚ö† ¬øEST√ÅS SEGURO?\n\nEsto borrar√° TODA la conversaci√≥n para TODOS los usuarios.");
            if(confirm1) {
                const confirm2 = confirm("¬øDe verdad? Esta acci√≥n no se puede deshacer.");
                if(confirm2) {
                    // Obtener todos los mensajes y borrarlos
                    const snapshot = await db.collection("messages").get();
                    if(snapshot.empty) {
                        alert("El chat ya est√° vac√≠o.");
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        db.collection("messages").doc(doc.id).delete();
                    });
                }
            }
        });

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Real con Firebase</title>
    <style>
        /* --- ESTILOS CSS --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #e5ddd5; margin: 0; display: flex; justify-content: center; height: 100vh; }
        
        /* Pantalla de Login */
        #login-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10;
        }
        .login-box { background: white; padding: 30px; border-radius: 10px; text-align: center; }
        .login-box input { padding: 10px; margin-bottom: 10px; width: 200px; border: 1px solid #ccc; border-radius: 5px; }
        .login-box button { padding: 10px 20px; background: #075e54; color: white; border: none; border-radius: 5px; cursor: pointer; }

        /* Contenedor del Chat */
        .chat-container { width: 100%; max-width: 600px; background: #fff; display: flex; flex-direction: column; height: 100%; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        header { background-color: #075e54; color: white; padding: 15px; text-align: center; font-weight: bold; }
        
        #messages-list {
            flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-color: #e5ddd5;
        }

        /* Burbujas */
        .msg { max-width: 70%; padding: 8px 15px; border-radius: 10px; font-size: 14px; position: relative; word-wrap: break-word; }
        .msg small { display: block; font-size: 10px; margin-top: 5px; opacity: 0.7; text-align: right; }
        .msg strong { display: block; font-size: 11px; margin-bottom: 2px; color: #e53935; }

        /* Mis mensajes (Derecha) */
        .sent { background-color: #dcf8c6; align-self: flex-end; border-top-right-radius: 0; }
        /* Mensajes de otros (Izquierda) */
        .received { background-color: white; align-self: flex-start; border-top-left-radius: 0; }

        /* Input area */
        form { display: flex; padding: 10px; background: #f0f0f0; }
        form input { flex: 1; padding: 10px; border-radius: 20px; border: none; outline: none; margin-right: 10px; }
        form button { background: #075e54; color: white; border: none; padding: 10px 20px; border-radius: 50%; cursor: pointer; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- PANTALLA DE LOGIN -->
    <div id="login-screen">
        <div class="login-box">
            <h2>Bienvenido al Chat</h2>
            <input type="text" id="usernameInput" placeholder="Tu nombre..." autocomplete="off">
            <button id="btnLogin">Entrar</button>
        </div>
    </div>

    <!-- PANTALLA DEL CHAT -->
    <div class="chat-container hidden" id="chat-screen">
        <header>Chat Grupal - Firebase</header>
        <div id="messages-list">
            <!-- Los mensajes se cargarán aquí -->
        </div>
        <form id="message-form">
            <input type="text" id="messageInput" placeholder="Escribe un mensaje..." autocomplete="off">
            <button type="submit">➤</button>
        </form>
    </div>

    <!-- LÓGICA JAVASCRIPT + FIREBASE -->
    <script type="module">
        // 1. IMPORTAR FUNCIONES DE FIREBASE (Versión Web Modular)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ------------------------------------------------------------------
        // 2. PEGA TU CONFIGURACIÓN AQUÍ (Reemplaza este objeto con el tuyo)
        // ------------------------------------------------------------------
        const firebaseConfig = {
             apiKey: "AIzaSyDD4ZgShyZGEnTYbGwNprjHwLxSVOnHBGI",
             authDomain: "ja-chat-59c9e.firebaseapp.com",
             projectId: "ja-chat-59c9e",
             storageBucket: "ja-chat-59c9e.firebasestorage.app",
             messagingSenderId: "967850675224",
             appId: "1:967850675224:web:809c09d0a3aa117696076d"
        };

        // 3. INICIALIZAR FIREBASE
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); // Base de datos

        // VARIABLES Y ELEMENTOS DOM
        let currentUser = "";
        const loginScreen = document.getElementById('login-screen');
        const chatScreen = document.getElementById('chat-screen');
        const usernameInput = document.getElementById('usernameInput');
        const btnLogin = document.getElementById('btnLogin');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('messageInput');
        const messagesList = document.getElementById('messages-list');

        // 4. FUNCIÓN: ENTRAR AL CHAT
        btnLogin.addEventListener('click', () => {
            const name = usernameInput.value.trim();
            if(name) {
                currentUser = name;
                loginScreen.classList.add('hidden');
                chatScreen.classList.remove('hidden');
                loadMessages(); // Iniciar la escucha de mensajes
            } else {
                alert("Por favor escribe un nombre");
            }
        });

        // 5. FUNCIÓN: ENVIAR MENSAJE A FIREBASE
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();

            if (text) {
                try {
                    // Guardar en Firestore (Colección 'messages')
                    await addDoc(collection(db, "messages"), {
                        user: currentUser,
                        text: text,
                        createdAt: serverTimestamp() // Hora del servidor
                    });
                    messageInput.value = ""; // Limpiar input
                } catch (error) {
                    console.error("Error enviando mensaje: ", error);
                }
            }
        });

        // 6. FUNCIÓN: ESCUCHAR MENSAJES EN TIEMPO REAL
        function loadMessages() {
            // Consulta: Dame la colección 'messages' ordenada por fecha
            const q = query(collection(db, "messages"), orderBy("createdAt", "asc"));

            // onSnapshot se ejecuta cada vez que algo cambia en la base de datos
            onSnapshot(q, (snapshot) => {
                messagesList.innerHTML = ""; // Limpiar lista actual
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const messageElement = document.createElement('div');
                    
                    // Definir si el mensaje es mio (sent) o de otro (received)
                    const messageType = data.user === currentUser ? 'sent' : 'received';
                    
                    // Formatear hora (si existe timestamp)
                    let time = "...";
                    if (data.createdAt) {
                        const date = data.createdAt.toDate();
                        time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }

                    messageElement.classList.add('msg', messageType);
                    messageElement.innerHTML = `
                        <strong>${data.user}</strong>
                        ${data.text}
                        <small>${time}</small>
                    `;
                    
                    messagesList.appendChild(messageElement);
                });

                // Auto-scroll al final
                messagesList.scrollTop = messagesList.scrollHeight;
            });
        }
    </script>
</body>
</html>
